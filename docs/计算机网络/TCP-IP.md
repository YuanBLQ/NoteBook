# TCP/IP 基础知识

## 历史背景

最初想到让不同电脑之间实现连接的，是美国加州大学洛杉矶分校网络工作小组的`斯蒂芬·克罗克`。

1970年，`克罗克`及其小组着手制定最初的主机对主机通信协议，它称为网络控制协议（Network Control Protocol，缩写NCP）。该协议用于`阿帕网(ARPANET)`，并在局部网络条件下运行稳定，但随着`阿帕网`用户的增多，NCP逐渐暴露出两大缺陷：

- NCP只是一台主机对另一台主机的通讯协议，**并未给网络中的每台电脑设置唯一的地址**，结果就造成电脑在越来越庞大的网络中难以准确定位需要传输数据的对象。
- **NCP缺乏纠错功能**，这样一来，数据在传输过程中一旦出现错误，网络就可能停止运行。出错电脑增多，使得网络运行效率大打折扣。

1972年，`罗伯特·卡恩`受雇于DARPA的信息技术处理办公室，在那里他研究卫星数据包网络和地面无线数据包网络，并且意识到能够在它们之间沟通的价值。

在1973年春天，`NCP`协议的开发者`文顿·瑟夫`加入到`卡恩`为ARPANET设计下一代协议而开发开放互连模型的工作中。

到了1973年夏天，`卡恩`和`瑟夫`很快开发出基本的改进形式，其中的网络协议之间的差异通过使用公用互联网协议而隐藏起来，且可靠性由主机保证而不是ARPANET那样由网络保证。

由于网络的作用减少到最小的程度，更有可能将任何网络连接到一起，而不用管它们不同的特点，这样能解决卡恩最初的问题。

1984年，美国国防部将TCP/IP作为所有计算机网络的标准。

2005年9月9日卡恩和瑟夫由于对美国文化的卓越贡献获总统自由勋章。

互联网早期除了TCP/IP外还有其他网络协议，但慢慢的都被TCP/IP打败，比如国际标准化组织ISO的OSI模型。TCP/IP成功的一个因素在于对众多低层协议的支持，这些低层协议对应到OSI模型中为第一层（物理层）和第二层（数据链路层）。每层的所有协议几乎都有一半数量支持TCP/IP。

## TCP/IP协议簇

常说的 TCP/IP 协议实际上指的是协议簇，而不是单单 TCP 和 IP 这两种协议。TCP/IP 协议簇具体有哪些看下面这张图就知道了。

![](https://pages.isyuan.site/tcpip/20210414225951.png)

通过上面那张图我们也可以看到，TCP/IP 协议中把 OSI 模型中的七层简化成了四层。

### 网络访问层

主要将数据从主机发送至网络。

### 网络层

管理网络间的数据寻址和传送，也就是解决主机到主机之间的通信问题。

### 传输层

数据交互的双方能通信之后，数据的稳定可靠传输就是传输层要做的事。

### 应用层

应用层架构大多都属于客户端/服务端模型（C/S）。提供服务的程序叫做服务端，接受服务的程序叫做客户端。

## 数据包传递历程

假设主机A和主机B要进行通信，主机A想给主机B发送一个数据包。这个过程都会经历哪些操作呢？

### 应用层的处理

主机A想要给主机B发送一句 `Hello`，这时候应用层需要先对这个数据包进行字符编码、格式化等处理。

### 传输层的处理

假设我们使用TCP进行传输，数据包发送的那一刻会建立TCP连接。

TCP会在应用层数据的前端附加一个TCP首部字段。

TCP首部包含 `源端口号` 和 `目标端口号`，这个端口号用于标识这个数据包从哪个程序发出的，需要发到哪个应用程序上；TCP首部还会有一个 `序号`，表示这个数据包在整个发送数据中的第几个字节的序列号；另外TCP首部还包含 `校验和`，用于判断数据是否损坏。

### 网络层的处理

网络层主要处理数据包的是 IP 协议。IP协议会在传过来的 TCP首部前再加上自己的 IP 首部。IP 首部包含目标地址和源地址。

紧随在 IP 首部的后面还有用来判断是 TCP 还是 UDP 的信息。

这套下来已经知道要发往何处了。

### 网路访问层

网络层传过来的数据，以太网也会和前几层一样加上以太网首部。以太网首部主要包含接收端的 MAC 地址、发送端的 MAC 地址以及标志以太网类型的以太网数据协议等。

下图是完整的处理和解析过程。

![](https://pages.isyuan.site/tcpip/20210419224405.png)

数据包的接收流程是发送流程的逆序，数据包解析同样是下面几步：

- 网络访问层解析。从以太网首部找到 MAC 地址判断是否是发给自己的数据包，如果是，判断以太网类型是哪种协议，如果是 IP 协议扔给 IP 协议处理，如果是 ARP 协议扔给 ARP 协议处理。如果是一种无法识别的协议，则丢弃。
- 网络层解析。假设上面判断是 IP 协议，那么收到数据包后就会解析 IP 首部，判断 IP 地址和自己是否匹配，如果匹配接收数据并判断上一层是 TCP 还是 UDP，同上如果不匹配则丢弃。
- 传输层解析。假设上面是 TCP 协议，这 TCP 处理过程中会先校验 `校验和`，判断数据是否损坏，然后检查序号，最后检查端口，确认是哪个应用程序的，并交由对应的应用层程序处理。
- 应用层处理。通过应用层解码等操作拿出真正数据内容，然后做出相应的处理。