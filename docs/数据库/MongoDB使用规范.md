# MongoDB最佳实践

## 使用规范

### 库/表设计

- 【强制】名称最多64个字符
- 【强制】禁止使用任何 `_` 以外的特殊字符，禁止数字开头
- 【建议】一个DB最多80个集合
- 【建议】单表集合数据量大可以选择拆表，每个小表可以放独立库或者sharding分表
- 【建议】合理使用“自动清理过期数据”功能，针对文档中的 `mongoDate()` 类型的时间字段增加一个 TTL 索引即可
- 【强制】尽量吧相同类型的文档放在一个集合中
- 【建议】尽量不要让数组字段成为查询条件

### 索引设计

- 【强制】组合索引策略遵循“最左原则”
- 【强制】索引名称长度不要超过128字符
- 【强制】尽可能把单列索引并入组合索引以降低索引数量
- 【建议】索引中包含的字符，尽量将数据基数大的字段放在组合索引的前面
- 【建议】优先使用覆盖索引
- 【建议】TTL索引尽量选择在业务低峰期执行

### 查询API规范

- 【强制】查询条件的字段或者排序条件的字段必须创建索引
- 【建议】查询结果只需包含所需字段，而不必查询所有字段
- 【建议】单个文档大小不超过16M
- 【建议】限定返回记录的条数，建议2000条，超过推荐使用多线程并发查询
- 【建议】写入大量数据的时候尽量选择 batchInsert 操作
- 【建议】索引中的 1 和 -1 表示正序和逆序，注意的是 {a:1, b:-1} 和 {a:-1, b:1} 是一样的
- 【建议】开发的时候尽量检查自己的语句性能，使用 `explain()` 函数检查查询执行详情
- 【建议】对于体积大小/文档数固定的集合，建议创建 `capped` 集合，写入性能高，但是不支持 `remove()` 和 `update()` 操作
- 【建议】`ne`、`not`、`exists`、`nin`、`or` 这些操作可能会导致性能低下，慎用
- 【建议】不要一次取太多数据进行排序
- 【建议】MongoDB的聚合框架很好用，可以通过简单的语法实现复杂的统计查询
- 【建议】清理集合所有数据使用 `drop()` 不要用 `remove()` 因为 `remove()` 是逐行操作
- 【建议】如果查询中有范围条件，尽量和定制条件放在一起过滤，并在创建索引的时候将定值查询字段放在范围查询字段的前面

## 常用命令



